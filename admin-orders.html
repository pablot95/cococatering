<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de √ìrdenes - Coc√≥ Catering</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bordo: #8B2E3A;
            --bordo-oscuro: #6B1E2A;
            --blanco: #FFFFFF;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: #f5f5f5;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        h1 {
            color: var(--bordo);
            margin-bottom: 30px;
            text-align: center;
        }

        .filters {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .filter-group label {
            font-size: 14px;
            color: #555;
            font-weight: bold;
        }

        .filter-group select,
        .filter-group button {
            padding: 8px 15px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
            cursor: pointer;
        }

        .filter-group button {
            background: var(--bordo);
            color: white;
            border: none;
            transition: background 0.3s;
        }

        .filter-group button:hover {
            background: var(--bordo-oscuro);
        }

        .orders-grid {
            display: grid;
            gap: 20px;
        }

        .order-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            transition: transform 0.3s, box-shadow 0.3s;
        }

        .order-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 20px rgba(0,0,0,0.15);
        }

        .order-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }

        .order-id {
            font-size: 12px;
            color: #777;
        }

        .order-date {
            font-size: 14px;
            color: #555;
        }

        .order-status {
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
        }

        .status-pending {
            background: #fff3cd;
            color: #856404;
        }

        .status-processing {
            background: #d1ecf1;
            color: #0c5460;
        }

        .status-completed {
            background: #d4edda;
            color: #155724;
        }

        .status-cancelled {
            background: #f8d7da;
            color: #721c24;
        }

        .customer-info {
            margin-bottom: 15px;
        }

        .customer-info h3 {
            font-size: 16px;
            color: var(--bordo);
            margin-bottom: 8px;
        }

        .customer-info p {
            font-size: 14px;
            color: #555;
            margin: 5px 0;
        }

        .products-list {
            margin-bottom: 15px;
        }

        .products-list h4 {
            font-size: 14px;
            color: #333;
            margin-bottom: 10px;
        }

        .product-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            background: #f9f9f9;
            border-radius: 5px;
            margin-bottom: 5px;
        }

        .product-name {
            font-size: 13px;
            color: #333;
        }

        .product-qty {
            font-size: 12px;
            color: #777;
        }

        .product-price {
            font-size: 14px;
            font-weight: bold;
            color: var(--bordo);
        }

        .order-total {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-top: 15px;
            border-top: 2px solid #f0f0f0;
            margin-top: 15px;
        }

        .total-label {
            font-size: 16px;
            font-weight: bold;
            color: #333;
        }

        .total-amount {
            font-size: 20px;
            font-weight: bold;
            color: var(--bordo);
        }

        .order-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .btn {
            flex: 1;
            padding: 8px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 13px;
            transition: opacity 0.3s;
        }

        .btn:hover {
            opacity: 0.8;
        }

        .btn-update {
            background: #28a745;
            color: white;
        }

        .btn-delete {
            background: #dc3545;
            color: white;
        }

        .loading {
            text-align: center;
            padding: 40px;
            font-size: 18px;
            color: #777;
        }

        .no-orders {
            text-align: center;
            padding: 60px 20px;
            background: white;
            border-radius: 10px;
        }

        .no-orders p {
            font-size: 18px;
            color: #777;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üì¶ Panel de √ìrdenes - Coc√≥ Catering</h1>

        <div class="filters">
            <div class="filter-group">
                <label for="statusFilter">Estado:</label>
                <select id="statusFilter">
                    <option value="all">Todas</option>
                    <option value="pending">Pendientes</option>
                    <option value="processing">En proceso</option>
                    <option value="completed">Completadas</option>
                    <option value="cancelled">Canceladas</option>
                </select>
            </div>
            <div class="filter-group">
                <button onclick="loadOrders()">üîÑ Actualizar</button>
            </div>
            <div class="filter-group">
                <button onclick="exportOrders()">üì• Exportar</button>
            </div>
        </div>

        <div id="ordersContainer" class="orders-grid">
            <div class="loading">Cargando √≥rdenes...</div>
        </div>
    </div>

    <script type="module">
        import { getAllOrders, getOrdersByStatus, updateOrderStatus, deleteOrder } from './firestore-service.js';

        let allOrders = [];

        // Cargar √≥rdenes al iniciar
        window.addEventListener('DOMContentLoaded', loadOrders);

        // Funci√≥n para cargar √≥rdenes
        window.loadOrders = async function() {
            const container = document.getElementById('ordersContainer');
            const statusFilter = document.getElementById('statusFilter').value;

            try {
                container.innerHTML = '<div class="loading">Cargando √≥rdenes...</div>';

                // Obtener √≥rdenes seg√∫n filtro
                if (statusFilter === 'all') {
                    allOrders = await getAllOrders();
                } else {
                    allOrders = await getOrdersByStatus(statusFilter);
                }

                if (allOrders.length === 0) {
                    container.innerHTML = `
                        <div class="no-orders">
                            <p>No hay √≥rdenes para mostrar</p>
                        </div>
                    `;
                    return;
                }

                // Renderizar √≥rdenes
                container.innerHTML = allOrders.map(order => renderOrderCard(order)).join('');

            } catch (error) {
                console.error('Error al cargar √≥rdenes:', error);
                container.innerHTML = `
                    <div class="no-orders">
                        <p>Error al cargar las √≥rdenes. Por favor, intenta nuevamente.</p>
                    </div>
                `;
            }
        };

        // Renderizar tarjeta de orden
        function renderOrderCard(order) {
            const statusClass = `status-${order.status}`;
            const statusText = {
                pending: 'Pendiente',
                processing: 'En proceso',
                completed: 'Completada',
                cancelled: 'Cancelada'
            }[order.status] || order.status;

            const date = order.createdAt ? new Date(order.createdAt.seconds * 1000).toLocaleString('es-AR') : 'Fecha no disponible';

            return `
                <div class="order-card">
                    <div class="order-header">
                        <div>
                            <div class="order-id">ID: ${order.id}</div>
                            <div class="order-date">${date}</div>
                        </div>
                        <span class="order-status ${statusClass}">${statusText}</span>
                    </div>

                    <div class="customer-info">
                        <h3>üë§ Cliente</h3>
                        <p><strong>${order.cliente.nombre}</strong></p>
                        <p>üìß ${order.cliente.email}</p>
                        <p>üì± ${order.cliente.telefono}</p>
                        <p>üìç ${order.direccionEnvio.calle} ${order.direccionEnvio.altura}, ${order.direccionEnvio.ciudad}, ${order.direccionEnvio.provincia}</p>
                    </div>

                    <div class="products-list">
                        <h4>üìã Productos</h4>
                        ${order.productos.map(product => `
                            <div class="product-item">
                                <span class="product-name">${product.nombre}</span>
                                <span class="product-qty">x${product.cantidad}</span>
                                <span class="product-price">$${(product.precio * product.cantidad).toLocaleString()}</span>
                            </div>
                        `).join('')}
                    </div>

                    <div class="order-total">
                        <span class="total-label">Total:</span>
                        <span class="total-amount">$${order.total.toLocaleString()}</span>
                    </div>

                    <div class="order-actions">
                        <select class="btn btn-update" onchange="updateStatus('${order.id}', this.value)">
                            <option value="">Cambiar estado...</option>
                            <option value="pending" ${order.status === 'pending' ? 'selected' : ''}>Pendiente</option>
                            <option value="processing" ${order.status === 'processing' ? 'selected' : ''}>En proceso</option>
                            <option value="completed" ${order.status === 'completed' ? 'selected' : ''}>Completada</option>
                            <option value="cancelled" ${order.status === 'cancelled' ? 'selected' : ''}>Cancelada</option>
                        </select>
                        <button class="btn btn-delete" onclick="deleteOrderConfirm('${order.id}')">üóëÔ∏è Eliminar</button>
                    </div>
                </div>
            `;
        }

        // Actualizar estado de orden
        window.updateStatus = async function(orderId, newStatus) {
            if (!newStatus) return;

            try {
                await updateOrderStatus(orderId, newStatus);
                alert('Estado actualizado exitosamente');
                loadOrders();
            } catch (error) {
                console.error('Error al actualizar estado:', error);
                alert('Error al actualizar el estado');
            }
        };

        // Eliminar orden con confirmaci√≥n
        window.deleteOrderConfirm = async function(orderId) {
            if (!confirm('¬øEst√°s seguro de que quieres eliminar esta orden?')) {
                return;
            }

            try {
                await deleteOrder(orderId);
                alert('Orden eliminada exitosamente');
                loadOrders();
            } catch (error) {
                console.error('Error al eliminar orden:', error);
                alert('Error al eliminar la orden');
            }
        };

        // Exportar √≥rdenes a CSV
        window.exportOrders = function() {
            if (allOrders.length === 0) {
                alert('No hay √≥rdenes para exportar');
                return;
            }

            const csv = convertToCSV(allOrders);
            downloadCSV(csv, 'ordenes-coco-catering.csv');
        };

        function convertToCSV(orders) {
            const headers = ['ID', 'Fecha', 'Cliente', 'Email', 'Tel√©fono', 'Direcci√≥n', 'Ciudad', 'Total', 'Estado'];
            const rows = orders.map(order => [
                order.id,
                order.createdAt ? new Date(order.createdAt.seconds * 1000).toLocaleString('es-AR') : '',
                order.cliente.nombre,
                order.cliente.email,
                order.cliente.telefono,
                `${order.direccionEnvio.calle} ${order.direccionEnvio.altura}`,
                order.direccionEnvio.ciudad,
                order.total,
                order.status
            ]);

            return [headers, ...rows].map(row => row.join(',')).join('\n');
        }

        function downloadCSV(csv, filename) {
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Filtro en tiempo real
        document.getElementById('statusFilter').addEventListener('change', loadOrders);
    </script>
</body>
</html>
